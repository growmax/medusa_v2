import{g as G}from"./chunk-WKOPGFW5-Di_6cJlP.js";import{a as X}from"./chunk-KWVVOB4B-Bc14zBvB.js";import{a as J}from"./chunk-OIW3F4EQ-D8V0uZdG.js";import{v as U,$ as Y,j as e,u as z,r as b,q as Z,a0 as ee,t as Q,H as se,I as T,a9 as V,T as O,g as te}from"./index-7A3rjJyE.js";import{T as ae}from"./chunk-PHMALPVO-EKeNghx2.js";import{R as k,u as ie}from"./chunk-BHGSRQH6-2xCUuk1R.js";import{u as le,a as R,F as m}from"./chunk-C7RYT3S3-C_x8NvOf.js";import{t as ne}from"./zod-DRKIF09R.js";import{z as N}from"./index-yuYasa5Y.js";import{C as re}from"./component-COQxFSkg.js";import{T as oe}from"./triangle-down-mini-BHNqpDM0.js";import{B as D}from"./label-DDCdtDlT.js";import{S as $}from"./select-cXhfXDq8.js";import{A as ce}from"./alert-Db7IDcs0.js";import"./chunk-DMYZ6SLX-BMyt3Z-P.js";import"./prompt-KZNvJYzq.js";import"./index-dBm6oMZZ.js";import"./triangles-mini-JWkpofVU.js";import"./x-mark-mini-Di7jARRp.js";function de({item:s,form:a,locationId:c,onQuantityChange:p}){const{t:u}=z(),l=s.variant,C=s.variant.inventory,[S,I]=b.useState(!1),d=R({control:a.control,name:"quantity"}),f=!!(l!=null&&l.inventory_items.length)&&(l==null?void 0:l.inventory_items.length)>1,{availableQuantity:n,inStockQuantity:A}=b.useMemo(()=>{var i,g;if(!l||!c)return{};const{inventory:r}=l,v=(g=(i=r[0])==null?void 0:i.location_levels)==null?void 0:g.find(t=>t.location_id===c);return v?{availableQuantity:v.available_quantity,inStockQuantity:v.stocked_quantity}:{}},[l,c]),E=!f&&n&&d[`${s.id}-${s.variant.inventory[0].id}`]&&d[`${s.id}-${s.variant.inventory[0].id}`]>n,F=0,j=Math.min(G(s),n||Number.MAX_SAFE_INTEGER);return e.jsxs("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 min-w-[720px] divide-y divide-dashed rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-x-3 p-3 text-sm",children:[e.jsx("div",{className:"flex flex-1 items-center",children:e.jsxs("div",{className:"flex items-center gap-x-3",children:[E&&e.jsx(V,{className:"text-ui-fg-error"}),e.jsx(ae,{src:s.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex flex-row",children:[e.jsx(O,{className:"txt-small flex",as:"span",weight:"plus",children:s.variant.product.title}),s.variant.sku&&e.jsxs("span",{className:"text-ui-fg-subtle",children:[" ","(",s.variant.sku,")"]}),f&&e.jsx(re,{className:"text-ui-fg-muted ml-2 overflow-visible pt-[2px]"})]}),e.jsx(O,{as:"div",className:"text-ui-fg-subtle txt-small",children:s.title})]})]})}),e.jsxs("div",{className:te("flex flex-1 items-center gap-x-3",f?"justify-end":"justify-between"),children:[!f&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"txt-small flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:u("labels.available")}),e.jsxs("span",{className:"text-ui-fg-muted",children:[n||"-",n&&!f&&d[`${s.id}-${s.variant.inventory[0].id}`]&&e.jsxs("span",{className:"text-ui-fg-error txt-small ml-1",children:["-",d[`${s.id}-${s.variant.inventory[0].id}`]]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"txt-small flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:u("labels.inStock")}),e.jsx("span",{className:"text-ui-fg-muted",children:A||"-"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-row items-center gap-2",children:[e.jsx(m.Field,{control:a.control,name:f?`quantity.${s.id}-`:`quantity.${s.id}-${s.variant.inventory[0].id}`,rules:{required:!f,min:!f&&F,max:j},render:({field:r})=>e.jsx(m.Item,{children:e.jsx(m.Control,{children:e.jsx(T,{className:"bg-ui-bg-base txt-small w-[46px] rounded-lg text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",type:"number",...r,disabled:!c,onChange:v=>{const i=v.target.value===""?null:Number(v.target.value);p(s.variant.inventory[0],s,f,i,!0)}})})})})," ","/ ",s.quantity," ",u("fields.qty")]})]})]})]}),f&&e.jsx("div",{className:"px-4 py-2",children:e.jsxs("div",{onClick:()=>I(r=>!r),className:"flex items-center gap-x-2",children:[e.jsx(oe,{style:{transform:`rotate(${S?-90:0}deg)`},className:"text-ui-fg-muted -mt-[1px]"}),e.jsx("span",{className:"txt-small text-ui-fg-muted cursor-pointer",children:u("orders.allocateItems.consistsOf",{num:C.length})})]})}),S&&l.inventory.map((r,v)=>{const i=r.location_levels.find(t=>t.location_id===c),g=!!d[`${s.id}-${r.id}`]&&d[`${s.id}-${r.id}`]>i.available_quantity;return e.jsxs("div",{className:"txt-small flex items-center gap-x-3 p-4",children:[e.jsxs("div",{className:"flex flex-1 flex-row items-center gap-3",children:[g&&e.jsx(V,{className:"text-ui-fg-error"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle",children:r.title}),e.jsx("span",{className:"text-ui-fg-muted",children:u("orders.allocateItems.requires",{num:l.inventory_items[v].required_quantity})})]})]}),e.jsxs("div",{className:"flex flex-1 flex-row justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"txt-small flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:u("labels.available")}),e.jsxs("span",{className:"text-ui-fg-muted",children:[(i==null?void 0:i.available_quantity)||"-",(i==null?void 0:i.available_quantity)&&d[`${s.id}-${r.id}`]&&e.jsxs("span",{className:"text-ui-fg-error txt-small ml-1",children:["-",d[`${s.id}-${r.id}`]]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"txt-small flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:u("labels.inStock")}),e.jsx("span",{className:"text-ui-fg-muted",children:(i==null?void 0:i.stocked_quantity)||"-"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"text-ui-fg-subtle txt-small mr-1 flex flex-row items-center gap-2",children:[e.jsx(m.Field,{control:a.control,name:`quantity.${s.id}-${r.id}`,rules:{required:!0,min:0,max:i==null?void 0:i.available_quantity},render:({field:t})=>e.jsx(m.Item,{children:e.jsx(m.Control,{children:e.jsx(T,{className:"bg-ui-bg-base txt-small w-[46px] rounded-lg text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",type:"number",...t,disabled:!c,onChange:x=>{const h=x.target.value===""?null:Number(x.target.value);p(r,s,f,h)}})})})}),"/"," ",s.quantity*l.inventory_items[v].required_quantity," ",u("fields.qty")]})]})]})]},r.id)})]})}var xe=N.object({location_id:N.string(),quantity:N.record(N.string(),N.number().or(N.string()))});function me({order:s}){var v,i,g;const{t:a}=z(),{handleSuccess:c}=ie(),[p,u]=b.useState(!1),[l,C]=b.useState(""),{mutateAsync:S,isPending:I}=X(),d=b.useMemo(()=>s.items.filter(t=>t.variant.manage_inventory&&t.variant.inventory.length&&t.quantity-t.detail.fulfilled_quantity>0),[s.items]),f=b.useMemo(()=>d.filter(t=>t.variant.title.toLowerCase().includes(l)||t.variant.product.title.toLowerCase().includes(l)),[d,l]);d.length;const n=le({defaultValues:{location_id:"",quantity:H(d)},resolver:ne(xe)}),{stock_locations:A=[]}=J(),E=n.handleSubmit(async t=>{try{const x=Object.entries(t.quantity).filter(([o])=>!o.endsWith("-")).map(([o,y])=>[...o.split("-"),y]);if(x.some(o=>o[2]==="")){n.setError("root.quantityNotAllocated",{type:"manual",message:a("orders.allocateItems.error.quantityNotAllocated")});return}const h=x.map(([o,y,_])=>S({location_id:t.location_id,inventory_item_id:y,line_item_id:o,quantity:_}));await Promise.all(h),await Z.invalidateQueries({queryKey:ee.details()}),c(`/orders/${s.id}`),Q.success(a("general.success"),{description:a("orders.allocateItems.toast.created"),dismissLabel:a("actions.close")})}catch(x){Q.error(a("general.error"),{description:x.message,dismissLabel:a("actions.close")})}}),F=(t,x,h,o,y)=>{let _=!1;const B=y&&h?`quantity.${x.id}-`:`quantity.${x.id}-${t.id}`;if(n.setValue(B,o),o){const q=t.location_levels.find(w=>w.location_id===j);q&&q.available_quantity<o&&(_=!0)}if(h&&!y&&n.resetField(`quantity.${x.id}-`,{defaultValue:""}),h&&y){const q=d.find(w=>w.id===x.id);q.variant.inventory_items.forEach((w,P)=>{const K=o||0,L=q.variant.inventory[P];if(n.setValue(`quantity.${x.id}-${L.id}`,K*w.required_quantity),o){const M=L.location_levels.find(W=>W.location_id===j);M&&M.available_quantity<o&&(_=!0)}})}n.clearErrors("root.quantityNotAllocated"),u(_)},j=R({name:"location_id",control:n.control});b.useEffect(()=>{j&&n.setValue("quantity",H(d))},[j]);const r=(g=(i=(v=n.formState.errors)==null?void 0:v.root)==null?void 0:i.quantityNotAllocated)==null?void 0:g.message;return e.jsx(k.Form,{form:n,children:e.jsxs("form",{onSubmit:E,className:"flex h-full flex-col overflow-hidden",children:[e.jsx(k.Header,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(k.Close,{asChild:!0,children:e.jsx(D,{size:"small",variant:"secondary",children:a("actions.cancel")})}),e.jsx(D,{size:"small",type:"submit",isLoading:I,disabled:!j||p,children:a("orders.allocateItems.action")})]})}),e.jsx(k.Body,{className:"flex h-full w-full flex-col items-center divide-y overflow-y-auto",children:e.jsx("div",{className:"flex size-full flex-col items-center overflow-auto p-16",children:e.jsx("div",{className:"flex w-full max-w-[736px] flex-col justify-center px-2 pb-2",children:e.jsxs("div",{className:"flex flex-col gap-8 divide-y divide-dashed",children:[e.jsx(se,{children:a("orders.allocateItems.title")}),e.jsxs("div",{className:"flex-1 divide-y divide-dashed pt-8",children:[e.jsx(m.Field,{control:n.control,name:"location_id",render:({field:{onChange:t,ref:x,...h}})=>e.jsxs(m.Item,{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(m.Label,{children:a("fields.location")}),e.jsx(m.Hint,{children:a("orders.allocateItems.locationDescription")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(m.Control,{children:e.jsxs($,{onValueChange:t,...h,children:[e.jsx($.Trigger,{className:"bg-ui-bg-base",ref:x,children:e.jsx($.Value,{})}),e.jsx($.Content,{children:A.map(o=>e.jsx($.Item,{value:o.id,children:o.name},o.id))})]})})})]}),e.jsx(m.ErrorMessage,{})]})}),e.jsxs(m.Item,{className:"mt-8 pt-8",children:[e.jsxs("div",{className:"flex flex-row items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(m.Label,{children:a("orders.allocateItems.itemsToAllocate")}),e.jsx(m.Hint,{children:a("orders.allocateItems.itemsToAllocateDesc")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(T,{value:l,onChange:t=>C(t.target.value),placeholder:a("orders.allocateItems.search"),autoComplete:"off",type:"search"})})]}),r&&e.jsx(ce,{className:"mb-4",dismissible:!0,variant:"error",children:r}),e.jsx("div",{className:"flex flex-col gap-y-1",children:f.map(t=>e.jsx(de,{form:n,item:t,locationId:j,onQuantityChange:F},t.id))})]})]})]})})})})]})})}function H(s){const a={};return s.forEach(c=>{const p=c.variant.inventory_items.length>1;a[p?`${c.id}-`:`${c.id}-${c.variant.inventory[0].id}`]="",p&&c.variant.inventory.forEach(u=>{a[`${c.id}-${u.id}`]=""})}),a}function Ee(){const{id:s}=U(),{order:a,isLoading:c,isError:p,error:u}=Y(s,{fields:"currency_code,*items,*items.variant,+items.variant.product.title,*items.variant.inventory,*items.variant.inventory.location_levels,*items.variant.inventory_items,*shipping_address"});if(p)throw u;const l=!c&&a;return e.jsx(k,{children:l&&e.jsx(me,{order:a})})}export{Ee as Component};
