import{E as F,M as D,U as R}from"./chunk-YHT3J3MK-DEyIm55G.js";import"./chunk-Y2QXUTMB-CYOiJYmV.js";import{d as G,e as U}from"./chunk-YBHG7T6S-BleHOTgO.js";import{r as b,v as O,j as e,d as W,u as I,s as H,L as P,a as K,n as N,G as X,T as B,x as Y,g as $,E as q}from"./index-7A3rjJyE.js";import{R as w,u as J}from"./chunk-BHGSRQH6-2xCUuk1R.js";import{u as Q,b as Z}from"./chunk-C7RYT3S3-C_x8NvOf.js";import{t as ee}from"./zod-DRKIF09R.js";import{T as se}from"./trash-C_lucST6.js";import{T as te}from"./thumbnail-badge-B_XgQTWQ.js";import{T as ie}from"./index-DFaNeppw.js";import{u as re}from"./use-prompt-iL3FbEo4.js";import{B as C}from"./label-DDCdtDlT.js";import{C as y}from"./command-bar-DBncXrlJ.js";import"./chunk-6GU6IDUA-CDc7wW5L.js";import"./index-yuYasa5Y.js";import"./index-Cy4zQj6C.js";import"./motion-UqVoX3oU.js";import"./chunk-DMYZ6SLX-BMyt3Z-P.js";import"./prompt-KZNvJYzq.js";var ne=({product:t})=>{const[s,r]=b.useState({}),{t:i}=I(),{handleSuccess:a}=J(),d=Q({defaultValues:{media:le(t.images,t.thumbnail)},resolver:ee(F)}),{fields:f,append:n,remove:o,update:x}=Z({name:"media",control:d.control,keyName:"field_id"}),{mutateAsync:u,isPending:g}=U(t.id),S=d.handleSubmit(async({media:h})=>{var E;const c=h.map((m,T)=>({file:m.file,index:T})).filter(m=>!!m.file);let p=[];if(c.length){const{files:m}=await H.admin.upload.create({files:c.map(T=>T.file)}).catch(()=>(d.setError("media",{type:"invalid_file",message:i("products.media.failedToUpload")}),{files:[]}));p=m}const j=h.map((m,T)=>{var V;const L=c.findIndex(A=>A.index===T);return L>-1?{...m,url:(V=p[L])==null?void 0:V.url}:m}),_=(E=j.find(m=>m.isThumbnail))==null?void 0:E.url;await u({images:j.map(m=>({url:m.url})),thumbnail:_||""},{onSuccess:()=>{a()}})}),z=b.useCallback(h=>c=>{if(c)r(p=>({...p,[h]:!0}));else{const{[h]:p,...j}=s;r(j)}},[s]),k=()=>{const c=Object.keys(s).map(p=>f.findIndex(j=>j.id===p));o(c),r({})},l=()=>{const h=Object.keys(s);if(!h.length)return;const c=f.findIndex(j=>j.isThumbnail);c>-1&&x(c,{...f[c],isThumbnail:!1});const p=f.findIndex(j=>j.id===h[0]);x(p,{...f[p],isThumbnail:!0}),r({})},v=Object.keys(s).length;return e.jsx(w.Form,{blockSearch:!0,form:d,children:e.jsxs("form",{className:"flex size-full flex-col overflow-hidden",onSubmit:S,children:[e.jsx(w.Header,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(w.Close,{asChild:!0,children:e.jsx(C,{variant:"secondary",size:"small",children:i("actions.cancel")})}),e.jsx(C,{variant:"secondary",size:"small",asChild:!0,children:e.jsx(P,{to:{pathname:".",search:void 0},children:i("products.media.galleryLabel")})}),e.jsx(C,{size:"small",type:"submit",isLoading:g,children:i("actions.save")})]})}),e.jsx(w.Body,{className:"flex flex-col overflow-hidden",children:e.jsxs("div",{className:"flex size-full flex-col-reverse lg:grid lg:grid-cols-[1fr_560px]",children:[e.jsx(D,{media:f,onCheckedChange:z,selection:s}),e.jsx("div",{className:"bg-ui-bg-base border-b px-6 py-4 lg:border-b-0 lg:border-l",children:e.jsx(R,{form:d,append:n})})]})}),e.jsx(y,{open:!!v,children:e.jsxs(y.Bar,{children:[e.jsx(y.Value,{children:i("general.countSelected",{count:v})}),e.jsx(y.Seperator,{}),v===1&&e.jsxs(b.Fragment,{children:[e.jsx(y.Command,{action:l,label:"Make thumbnail",shortcut:"t"}),e.jsx(y.Seperator,{})]}),e.jsx(y.Command,{action:k,label:i("actions.delete"),shortcut:"d"})]})})]})})},le=(t,s)=>{const r=(t==null?void 0:t.map(i=>({id:i.id,url:i.url,isThumbnail:i.url===s,file:null})))||[];if(s&&!r.some(i=>i.url===s)){const i=Math.random().toString(36).substring(7);r.unshift({id:i,url:s,isThumbnail:!0,file:null})}return r},ae=({product:t})=>{const{state:s}=K(),[r,i]=b.useState((s==null?void 0:s.curr)||0),{t:a}=I(),d=re(),{mutateAsync:f,isLoading:n}=U(t.id),o=de(t.images,t.thumbnail),x=b.useCallback(()=>{n||i(l=>(l+1)%o.length)},[o,n]),u=b.useCallback(()=>{n||i(l=>(l-1+o.length)%o.length)},[o,n]),g=b.useCallback(l=>{n||i(l)},[n]),S=()=>{if(n)return;const l=document.createElement("a");l.href=o[r].url,l.download="image",l.target="_blank",l.click()},z=async()=>{const l=o[r];if(!await d({title:a("general.areYouSure"),description:l.isThumbnail?a("products.media.deleteWarningWithThumbnail",{count:1}):a("products.media.deleteWarning",{count:1}),confirmText:a("actions.delete"),cancelText:a("actions.cancel")}))return;const h=t.images.filter(c=>c.id!==l.id).map(c=>c.url);r===o.length-1&&i(c=>c-1),await f({images:h,thumbnail:l.isThumbnail?"":void 0})};b.useEffect(()=>{const l=v=>{v.key==="ArrowRight"?x():v.key==="ArrowLeft"&&u()};return document.addEventListener("keydown",l),()=>{document.removeEventListener("keydown",l)}},[x,u]);const k=!o.length;return e.jsxs("div",{className:"flex size-full flex-col overflow-hidden",children:[e.jsx(w.Header,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsxs(N,{size:"small",type:"button",onClick:z,disabled:k,children:[e.jsx(se,{}),e.jsx("span",{className:"sr-only",children:a("products.media.deleteImageLabel")})]}),e.jsxs(N,{size:"small",type:"button",onClick:S,disabled:k,children:[e.jsx(X,{}),e.jsx("span",{className:"sr-only",children:a("products.media.downloadImageLabel")})]}),e.jsx(C,{variant:"secondary",size:"small",asChild:!0,children:e.jsx(P,{to:{pathname:".",search:"view=edit"},children:a("actions.edit")})})]})}),e.jsxs(w.Body,{className:"flex flex-col overflow-hidden",children:[e.jsx(oe,{curr:r,media:o}),e.jsx(ce,{curr:r,media:o,prev:u,next:x,goTo:g})]})]})},oe=({media:t,curr:s})=>{const{t:r}=I();return t.length===0?e.jsxs("div",{className:"bg-ui-bg-subtle flex size-full flex-col items-center justify-center gap-y-4 pb-8 pt-6",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(B,{size:"small",leading:"compact",weight:"plus",className:"text-ui-fg-subtle",children:r("products.media.emptyState.header")}),e.jsx(B,{size:"small",className:"text-ui-fg-muted",children:r("products.media.emptyState.description")})]}),e.jsx(C,{size:"small",variant:"secondary",asChild:!0,children:e.jsx(P,{to:"?view=edit",children:r("products.media.emptyState.action")})})]}):e.jsx("div",{className:"bg-ui-bg-subtle relative size-full overflow-hidden",children:e.jsx("div",{className:"flex size-full items-center justify-center p-6",children:e.jsxs("div",{className:"relative h-full w-fit",children:[t[s].isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(Y,{content:r("products.media.thumbnailTooltip"),children:e.jsx(te,{})})}),e.jsx("img",{src:t[s].url,alt:"",className:"object-fit shadow-elevation-card-rest size-full rounded-xl object-contain"})]})})})},M=8,ce=({media:t,curr:s,prev:r,next:i,goTo:a})=>{if(!t.length)return null;const f=((n,o)=>{if(n.length<=M)return n;const x=Math.floor(M/2),u=(o-x+n.length)%n.length,g=(u+M)%n.length;return g<u?[...n.slice(u),...n.slice(0,g)]:n.slice(u,g)})(t,s);return e.jsxs("div",{className:"flex shrink-0 items-center justify-center gap-x-2 border-t p-3",children:[e.jsx(N,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:r,children:e.jsx(ie,{})}),e.jsx("div",{className:"flex items-center gap-x-2",children:f.map(n=>{const o=n.id===t[s].id,x=t.findIndex(u=>u.id===n.id);return e.jsx("button",{type:"button",onClick:()=>a(x),className:$("transition-fg size-7 overflow-hidden rounded-[4px] outline-none",{"shadow-borders-focus":o}),children:e.jsx("img",{src:n.url,alt:"",className:"size-full object-cover"})},n.id)})}),e.jsx(N,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:i,children:e.jsx(q,{})})]})},de=(t,s)=>{const r=(t==null?void 0:t.map(i=>({id:i.id,url:i.url,isThumbnail:i.url===s})))||[];return s&&!r.some(i=>i.isThumbnail)&&r.unshift({id:"thumbnail_only",url:s,isThumbnail:!0}),r},ue=b.createContext(null),me=t=>t.get("view")==="edit"?"edit":"gallery",he=({product:t})=>{const[s,r]=W(),i=me(s),a=d=>()=>{r({view:d})};return e.jsx(ue.Provider,{value:{goToGallery:a("gallery"),goToEdit:a("edit")},children:fe(i,t)})},fe=(t,s)=>{switch(t){case"gallery":return e.jsx(ae,{product:s});case"edit":return e.jsx(ne,{product:s})}},Ve=()=>{const{id:t}=O(),{product:s,isLoading:r,isError:i,error:a}=G(t),d=!r&&s;if(i)throw a;return e.jsx(w,{children:d&&e.jsx(he,{product:s})})};export{Ve as Component};
