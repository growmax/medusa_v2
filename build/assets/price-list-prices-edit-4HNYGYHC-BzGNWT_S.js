import{c as R,u as S,b as I}from"./chunk-W6XVKIR4-FmInSyUk.js";import{i as E}from"./chunk-G2J2T2QU-CMBJZuqd.js";import{c as T,f as w}from"./chunk-GMJC4MQM-BknCPGqF.js";import{v as O,d as M,j as l,u as N,r as D,t as v}from"./index-7A3rjJyE.js";import{D as F}from"./chunk-ZUTZJQ3C-BDh6pyCy.js";import"./index.esm-L0DzsZPB.js";import{u as $}from"./chunk-C7RYT3S3-C_x8NvOf.js";import{c as x}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{u as k}from"./chunk-YBHG7T6S-BleHOTgO.js";import{R as P,u as z}from"./chunk-BHGSRQH6-2xCUuk1R.js";import{t as B}from"./zod-DRKIF09R.js";import{z as U}from"./index-yuYasa5Y.js";import{B as _}from"./label-DDCdtDlT.js";import"./chunk-PHMALPVO-EKeNghx2.js";import"./chunk-XVFLU5BP-pJYp3bDo.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./chunk-QHCOJC4V-B0yC0oe2.js";import"./chunk-YVTBRLIE-C161Iqr5.js";import"./chunk-RYVWLLZ2-BlkKIhzO.js";import"./chunk-GH77ZQI2-CyzKiLW4.js";import"./index-DL2eSRCZ.js";import"./chunk-DMYZ6SLX-BMyt3Z-P.js";import"./prompt-KZNvJYzq.js";var A=U.object({products:R}),G=({priceList:o,products:m,regions:i,currencies:d,pricePreferences:c})=>{const{t:n}=N(),{handleSuccess:a}=z(),t=D.useRef(V(o,m)),e=$({defaultValues:{products:t.current},resolver:B(A)}),{mutateAsync:s,isPending:r}=w(o.id),p=e.handleSubmit(async f=>{const{products:h}=f,{pricesToDelete:g,pricesToCreate:y,pricesToUpdate:C}=K(h,t.current,i);s({delete:g,update:C,create:y},{onSuccess:()=>{v.success(n("priceLists.products.edit.successToast")),a()},onError:L=>{v.error(L.message)}})}),u=I({currencies:d,regions:i,pricePreferences:c});return l.jsx(P.Form,{form:e,children:l.jsxs("form",{onSubmit:p,className:"flex size-full flex-col",children:[l.jsx(P.Header,{}),l.jsx(P.Body,{className:"flex flex-col overflow-hidden",children:l.jsx(F,{columns:u,data:m,getSubRows:f=>{if(E(f)&&f.variants)return f.variants},state:e})}),l.jsx(P.Footer,{children:l.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[l.jsx(P.Close,{asChild:!0,children:l.jsx(_,{size:"small",variant:"secondary",children:n("actions.cancel")})}),l.jsx(_,{size:"small",type:"submit",isLoading:r,children:n("actions.save")})]})})]})})};function V(o,m){var c,n;const i={},d=(c=o.prices)==null?void 0:c.reduce((a,t)=>{var r;const e=a[t.variant_id]||{};if(!!((r=t.rules)!=null&&r.region_id)){const p=t.rules.region_id;e.region_prices={...e.region_prices,[p]:{amount:t.amount.toString(),id:t.id}}}else e.currency_prices={...e.currency_prices,[t.currency_code]:{amount:t.amount.toString(),id:t.id}};return a[t.variant_id]=e,a},{});for(const a of m)i[a.id]={variants:((n=a.variants)==null?void 0:n.reduce((t,e)=>{const s=d[e.id]||{};return t[e.id]=s,t},{}))||{}};return i}function j(o,m){const i=[],d=m.reduce((c,n)=>(c[n.id]=n.currency_code,c),{});for(const[c,n]of Object.entries(o||{})){const{variants:a}=n||{};for(const[t,e]of Object.entries(a||{})){const{currency_prices:s,region_prices:r}=e||{};for(const[p,u]of Object.entries(s||{}))u!=null&&u.amount&&i.push({variantId:t,currencyCode:p,amount:x(u.amount),id:u.id});for(const[p,u]of Object.entries(r||{}))u!=null&&u.amount&&i.push({variantId:t,regionId:p,currencyCode:d[p],amount:x(u.amount),id:u.id})}}return i}function b(o){return`${o.variantId}-${o.currencyCode}-${o.regionId||"none"}-${o.id||"none"}`}function H(o,m){const i=[],d=[],c=[],n=o.reduce((e,s)=>(e[b(s)]=s,e),{}),a=m.reduce((e,s)=>(e[b(s)]=s,e),{}),t=new Set([...Object.keys(n),...Object.keys(a)]);for(const e of t){const s=n[e],r=a[e];s&&r&&(isNaN(r.amount)&&r.id&&c.push(r.id),s.amount!==r.amount&&r.id&&i.push({id:r.id,variant_id:r.variantId,currency_code:r.currencyCode,rules:r.regionId?{region_id:r.regionId}:void 0,amount:r.amount})),!s&&r&&d.push({variant_id:r.variantId,currency_code:r.currencyCode,rules:r.regionId?{region_id:r.regionId}:void 0,amount:r.amount}),s&&!r&&s.id&&c.push(s.id)}return{pricesToDelete:c,pricesToCreate:d,pricesToUpdate:i}}function K(o,m,i){const d=j(m,i),c=j(o,i);return H(d,c)}var hr=()=>{const{id:o}=O(),[m]=M(),i=m.get("ids[]"),{price_list:d,isLoading:c,isError:n,error:a}=T(o),t=i==null?void 0:i.split(","),{products:e,isLoading:s,isError:r,error:p}=k({id:t,limit:(t==null?void 0:t.length)||9999,price_list_id:[o],fields:"title,thumbnail,*variants"}),{isReady:u,regions:f,currencies:h,pricePreferences:g}=S(),y=!c&&!!d&&!s&&!!e&&u;if(n)throw a;if(r)throw p;return l.jsx(P,{children:y&&l.jsx(G,{priceList:d,products:e,regions:f,currencies:h,pricePreferences:g})})};export{hr as Component};
