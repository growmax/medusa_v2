import{P as q,u as Q,b as W}from"./chunk-W6XVKIR4-FmInSyUk.js";import{e as X,i as Z}from"./chunk-G2J2T2QU-CMBJZuqd.js";import{c as J,f as U}from"./chunk-GMJC4MQM-BknCPGqF.js";import{v as Y,j as e,r as S,u as G,t as N,k as ee,x as O}from"./index-7A3rjJyE.js";import{u as re}from"./chunk-QBDU475K-BjRzsrqf.js";import{u as te,a as se}from"./chunk-OGPZJ7JQ-9Z-hWx5h.js";import{D as ie}from"./chunk-ZUTZJQ3C-BDh6pyCy.js";import"./index.esm-L0DzsZPB.js";import{u as oe,a as F}from"./chunk-C7RYT3S3-C_x8NvOf.js";import{u as ce,D as ae}from"./chunk-MOFW5DA3-Byx5Qi5u.js";import"./lodash-8s6kkRaG.js";import"./chunk-7LAPOKHJ-BtMb3RyP.js";import"./chunk-M566SHKI-Cmdx6k9x.js";import{u as H}from"./chunk-YBHG7T6S-BleHOTgO.js";import{R as y,u as ne}from"./chunk-BHGSRQH6-2xCUuk1R.js";import{t as de}from"./zod-DRKIF09R.js";import{z as D}from"./index-yuYasa5Y.js";import{P as j}from"./progress-tabs-CBvjkL6b.js";import{B as _}from"./label-DDCdtDlT.js";import{C as B}from"./checkbox-BD385cy_.js";import{c as le}from"./index-DL2eSRCZ.js";import"./chunk-PHMALPVO-EKeNghx2.js";import"./chunk-XVFLU5BP-pJYp3bDo.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./chunk-QHCOJC4V-B0yC0oe2.js";import"./chunk-6GU6IDUA-CDc7wW5L.js";import"./chunk-YVTBRLIE-C161Iqr5.js";import"./chunk-RYVWLLZ2-BlkKIhzO.js";import"./chunk-6XHB4MRO-DKQXmGFz.js";import"./chunk-ADOCJB6L-3PFdxvdK.js";import"./chunk-P3UUX2T6-Bigsa15J.js";import"./chunk-OPYB3EPU-B_-LG2wj.js";import"./chunk-C76H5USB-qWdDTOoY.js";import"./chunk-TQZNQHGA-CqGicYvo.js";import"./chunk-GH77ZQI2-CyzKiLW4.js";import"./chunk-5FUV23JF-QRqJ2E8j.js";import"./chunk-RKBIB2RM-jqr0zPdv.js";import"./chunk-WX2SMNCD-D4nWbVrW.js";import"./plus-mini-BHxdUq8n.js";import"./command-bar-DBncXrlJ.js";import"./index-DFaNeppw.js";import"./chunk-QAF7PVQE-exoP4XGT.js";import"./format-CkWRMO1y.js";import"./_baseIsEqual-D9C7gzzJ.js";import"./date-picker-foikjjE_.js";import"./clsx-B-dksMZM.js";import"./x-mark-mini-Di7jARRp.js";import"./chunk-DMYZ6SLX-BMyt3Z-P.js";import"./prompt-KZNvJYzq.js";import"./index-dBm6oMZZ.js";var ue=({form:i,currencies:t,regions:a,pricePreferences:m})=>{const o=F({control:i.control,name:"product_ids"}),p=F({control:i.control,name:"products"}),{products:l,isLoading:n,isError:f,error:h}=H({id:o.map(d=>d.id),limit:o.length,fields:"title,thumbnail,*variants"}),{setValue:u}=i;S.useEffect(()=>{!n&&l&&l.forEach(d=>{p[d.id]||!d.variants||u(`products.${d.id}.variants`,{...d.variants.reduce((b,T)=>(b[T.id]={currency_prices:{},region_prices:{}},b),{})})})},[l,p,n,u]);const C=W({currencies:t,regions:a,pricePreferences:m});if(f)throw h;return e.jsx("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:e.jsx(ie,{columns:C,data:l,getSubRows:d=>{if(Z(d)&&d.variants)return d.variants},state:i})})},I=50,M="p";function me(i){return i.reduce((t,a)=>(t[a.id]=!0,t),{})}var pe=({priceList:i,form:t})=>{const{control:a,setValue:m}=t,o=S.useMemo(()=>i.prices.reduce((r,c)=>(r[c.variant_id]=!0,r),{}),[i.prices]),p=F({control:a,name:"product_ids"}),l=F({control:a,name:"products"}),[n,f]=S.useState(me(p)),{searchParams:h,raw:u}=te({pageSize:I,prefix:M}),{products:C,count:d,isLoading:b,isError:T,error:E}=H(h,{placeholderData:ee}),w=r=>{const c=typeof r=="function"?r(n):r,P=Object.keys(c),k=Object.keys(l).reduce((R,A)=>(P.includes(A)&&(R[A]=l[A]),R),{}),$=P.map(R=>({id:R}));m("product_ids",$,{shouldDirty:!0,shouldTouch:!0}),m("products",k,{shouldDirty:!0,shouldTouch:!0}),f(c)},L=he(),s=se(),{table:x}=ce({data:C||[],columns:L,count:d,enablePagination:!0,enableRowSelection:r=>{var c,P;return!!((c=r.original.variants)!=null&&c.length)&&!((P=r.original.variants)!=null&&P.some(v=>o[v.id]))},getRowId:r=>r.id,rowSelection:{state:n,updater:w},pageSize:I,meta:{variantIdMap:o}});if(T)throw E;return e.jsx("div",{className:"flex size-full flex-col",children:e.jsx(ae,{table:x,columns:L,filters:s,pageSize:I,prefix:M,count:d,isLoading:b,layout:"fill",orderBy:["title","status","created_at","updated_at"],pagination:!0,search:!0,queryObject:u})})},fe=le(),he=()=>{const i=re();return S.useMemo(()=>[fe.display({id:"select",header:({table:t})=>e.jsx(B,{checked:t.getIsSomePageRowsSelected()?"indeterminate":t.getIsAllPageRowsSelected(),onCheckedChange:a=>t.toggleAllPageRowsSelected(!!a)}),cell:({row:t,table:a})=>{var f;const{variantIdMap:m}=a.options.meta,o=(f=t.original.variants)==null?void 0:f.some(h=>m[h.id]),p=!t.getCanSelect()||o,l=t.getIsSelected()||o,n=e.jsx(B,{checked:l,disabled:p,onCheckedChange:h=>t.toggleSelected(!!h),onClick:h=>{h.stopPropagation()}});return o?e.jsx(O,{content:"This product is already in the price list",children:n}):p?e.jsx(O,{content:"This product has no variants",children:n}):n}}),...i],[i])},z=D.object({product_ids:D.array(D.object({id:D.string()})).min(1),products:q}),K=z.pick({product_ids:!0}),V=Object.keys(K.shape),xe=z.pick({products:!0}),Pe=Object.keys(xe.shape),g=["product","price"],ge={product:"in-progress",price:"not-started"},ve=({priceList:i,regions:t,currencies:a,pricePreferences:m})=>{const[o,p]=S.useState("product"),[l,n]=S.useState(ge),{t:f}=G(),{handleSuccess:h}=ne(),u=oe({defaultValues:{products:{},product_ids:[]},resolver:de(z)}),{mutateAsync:C,isPending:d}=U(i.id),b=u.handleSubmit(async s=>{const{products:x}=s,r=X(x,t);await C({create:r},{onSuccess:()=>{N.success(f("priceLists.products.add.successToast")),h()},onError:c=>N.error(c.message)})}),T=(s,x)=>{u.clearErrors(s);const r=s.reduce((P,v)=>(P[v]=u.getValues(v),P),{}),c=x.safeParse(r);return c.success?!0:(c.error.errors.forEach(({path:P,message:v,code:k})=>{u.setError(P.join("."),{type:k,message:v})}),!1)},E=s=>{switch(s){case"product":return V.some(r=>u.getFieldState(r).isDirty);case"price":return Pe.some(r=>u.getFieldState(r).isDirty)}},w=s=>{if(o===s)return;if(g.indexOf(s)<g.indexOf(o)){const r=E(o);n(c=>({...c,[o]:r?c[o]:"not-started",[s]:"in-progress"})),p(s);return}const x=g.slice(0,g.indexOf(s));for(const r of x)if(r==="product"){if(!T(V,K)){n(c=>({...c,[r]:"in-progress"})),p(r);return}n(c=>({...c,[r]:"completed"}))}n(r=>({...r,[o]:"completed",[s]:"in-progress"})),p(s)},L=s=>{if(g.indexOf(s)+1>=g.length)return;const x=g[g.indexOf(s)+1];w(x)};return e.jsx(y.Form,{form:u,children:e.jsx(j,{value:o,onValueChange:s=>w(s),className:"flex h-full flex-col overflow-hidden",children:e.jsxs("form",{onSubmit:b,className:"flex h-full flex-col",children:[e.jsx(y.Header,{children:e.jsx("div",{className:"flex w-full items-center justify-between gap-x-4",children:e.jsx("div",{className:"-my-2 w-full max-w-[600px] border-l",children:e.jsxs(j.List,{className:"grid w-full grid-cols-3",children:[e.jsx(j.Trigger,{status:l.product,value:"product",children:f("priceLists.create.tabs.products")}),e.jsx(j.Trigger,{status:l.price,value:"price",children:f("priceLists.create.tabs.prices")})]})})})}),e.jsxs(y.Body,{className:"size-full overflow-hidden",children:[e.jsx(j.Content,{className:"size-full overflow-y-auto",value:"product",children:e.jsx(pe,{form:u,priceList:i})}),e.jsx(j.Content,{className:"size-full overflow-hidden",value:"price",children:e.jsx(ue,{form:u,regions:t,currencies:a,pricePreferences:m})})]}),e.jsx(y.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(y.Close,{asChild:!0,children:e.jsx(_,{variant:"secondary",size:"small",children:f("actions.cancel")})}),e.jsx(be,{tab:o,next:L,isLoading:d})]})})]})})})},be=({tab:i,next:t,isLoading:a})=>{const{t:m}=G();return i==="price"?e.jsx(_,{type:"submit",variant:"primary",size:"small",isLoading:a,children:m("actions.save")},"submit-button"):e.jsx(_,{type:"button",variant:"primary",size:"small",onClick:()=>t(i),children:m("actions.continue")},"next-button")},Pr=()=>{const{id:i}=Y(),{price_list:t,isPending:a,isError:m,error:o}=J(i),{currencies:p,regions:l,pricePreferences:n,isReady:f}=Q(),h=f&&!a&&!!t;if(m)throw o;return e.jsx(y,{children:h&&e.jsx(ve,{priceList:t,currencies:p,regions:l,pricePreferences:n})})};export{Pr as Component};
