import{g as y}from"./chunk-WKOPGFW5-Di_6cJlP.js";import{M as S}from"./chunk-LHJ6JQGA-DwzzZUWf.js";import{X as w,s as q,Y as M,v as T,$ as k,j as e,u as I,a7 as A,r as N,t as E,T as F,I as L}from"./index-7A3rjJyE.js";import{a as Q}from"./chunk-OIW3F4EQ-D8V0uZdG.js";import{T as R}from"./chunk-PHMALPVO-EKeNghx2.js";import{A as O}from"./chunk-WRXTMI2J-CygmDunM.js";import{m as V}from"./chunk-YBHG7T6S-BleHOTgO.js";import{R as g,u as $}from"./chunk-BHGSRQH6-2xCUuk1R.js";import{u as P,a as z,F as l}from"./chunk-C7RYT3S3-C_x8NvOf.js";import{t as H}from"./zod-DRKIF09R.js";import{z as h}from"./index-yuYasa5Y.js";import{T as B}from"./trash-C_lucST6.js";import{B as C}from"./label-DDCdtDlT.js";import{S as v}from"./select-cXhfXDq8.js";import{A as K}from"./alert-Db7IDcs0.js";import{S as D}from"./switch-DDIyRuzh.js";import"./chunk-FSMQADBD-DQ6u7KYm.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./chunk-P3UUX2T6-Bigsa15J.js";import"./chunk-DMYZ6SLX-BMyt3Z-P.js";import"./prompt-KZNvJYzq.js";import"./index-dBm6oMZZ.js";import"./triangles-mini-JWkpofVU.js";import"./x-mark-mini-Di7jARRp.js";var Y="fulfillment_providers",U=M(Y),X=(r,i)=>{const{data:d,...m}=w({queryFn:()=>q.admin.fulfillmentProvider.list(r),queryKey:U.list(r),...i});return{...d,...m}},G=h.object({quantity:h.record(h.string(),h.number()),location_id:h.string(),send_notification:h.boolean().optional()});function W({item:r,currencyCode:i,form:d,locationId:m,onItemRemove:j}){const{t:a}=I(),{variant:u}=V(r.variant.product_id,r.variant_id,{fields:"*inventory,*inventory.location_levels"}),n=!!(u!=null&&u.inventory.length),{availableQuantity:o,inStockQuantity:_}=N.useMemo(()=>{var t,c;if(!u||!m)return{};const{inventory:x}=u,s=(c=(t=x[0])==null?void 0:t.location_levels)==null?void 0:c.find(p=>p.location_id===m);return s?{availableQuantity:s.available_quantity,inStockQuantity:s.stocked_quantity}:{}},[u,m]),b=0,f=Math.min(y(r),o||Number.MAX_SAFE_INTEGER);return e.jsxs("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:[e.jsxs("div",{className:"flex gap-x-2 border-b p-3 text-sm",children:[e.jsxs("div",{className:"flex flex-grow items-center gap-x-3",children:[e.jsx(R,{src:r.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsx(F,{className:"txt-small",as:"span",weight:"plus",children:r.title}),r.variant.sku&&e.jsxs("span",{children:["(",r.variant.sku,")"]})]}),e.jsx(F,{as:"div",className:"text-ui-fg-subtle txt-small",children:r.variant.title})]})]}),e.jsxs("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0 flex-col items-center",children:[e.jsx(S,{className:"justify-end",currencyCode:i,amount:r.total}),n&&e.jsxs("span",{children:[a("orders.fulfillment.available"),": ",o||"N/A"," ","Â· ",a("orders.fulfillment.inStock"),": ",_||"N/A"]})]}),e.jsx("div",{className:"flex items-center",children:e.jsx(O,{groups:[{actions:[{label:a("actions.remove"),icon:e.jsx(B,{}),onClick:()=>j(r.id)}]}]})})]}),e.jsx("div",{className:"block p-3 text-sm",children:e.jsxs("div",{className:"flex-1",children:[e.jsx(F,{weight:"plus",className:"txt-small mb-2",children:a("fields.quantity")}),e.jsx(l.Field,{control:d.control,name:`quantity.${r.id}`,rules:{required:!0,min:b,max:f},render:({field:x})=>e.jsxs(l.Item,{children:[e.jsx(l.Control,{children:e.jsx(L,{className:"bg-ui-bg-base txt-small w-full rounded-lg",type:"number",...x,onChange:s=>{const t=s.target.value===""?null:Number(s.target.value);x.onChange(t),isNaN(t)||(t<b||t>f?d.setError(`quantity.${r.id}`,{type:"manual",message:a("orders.fulfillment.error.wrongQuantity",{count:f,number:f})}):d.clearErrors(`quantity.${r.id}`))}})}),e.jsx(l.ErrorMessage,{})]})})]})})]})}function J({order:r}){const{t:i}=I(),{handleSuccess:d}=$(),{mutateAsync:m,isPending:j}=A(r.id);X({region_id:r.region_id});const[a,u]=N.useState(()=>r.items.filter(s=>y(s)>0)),n=P({defaultValues:{quantity:a.reduce((s,t)=>(s[t.id]=y(t),s),{}),send_notification:!r.no_notification},resolver:H(G)}),{stock_locations:o=[]}=Q(),_=n.handleSubmit(async s=>{try{await m({location_id:s.location_id,no_notification:!s.send_notification,items:Object.entries(s.quantity).filter(([,t])=>!!t).map(([t,c])=>({id:t,quantity:c}))}),E.success(i("orders.fulfillment.toast.created")),d(`/orders/${r.id}`)}catch(t){E.error(t.message)}});N.useEffect(()=>{o!=null&&o.length&&n.setValue("location_id",o[0].id)},[o==null?void 0:o.length]);const b=s=>{u(t=>t.filter(c=>c.id!==s)),n.unregister(`quantity.${s}`)},f=()=>{const s=r.items.filter(t=>y(t)>0);u(s),s.forEach(t=>n.register(`quantity.${t.id}`,{value:y(t)})),n.clearErrors("root")},x=z({name:"location_id",control:n.control});return N.useEffect(()=>{a.length||n.setError("root",{type:"manual",message:i("orders.fulfillment.error.noItems")})},[a.length]),e.jsx(g.Form,{form:n,children:e.jsxs("form",{onSubmit:_,className:"flex h-full flex-col overflow-hidden",children:[e.jsx(g.Header,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(g.Close,{asChild:!0,children:e.jsx(C,{size:"small",variant:"secondary",children:i("actions.cancel")})}),e.jsx(C,{size:"small",type:"submit",isLoading:j,children:i("orders.fulfillment.create")})]})}),e.jsx(g.Body,{className:"flex h-full w-full flex-col items-center divide-y overflow-y-auto",children:e.jsx("div",{className:"flex size-full flex-col items-center overflow-auto p-16",children:e.jsx("div",{className:"flex w-full max-w-[736px] flex-col justify-center px-2 pb-2",children:e.jsxs("div",{className:"flex flex-col divide-y",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(l.Field,{control:n.control,name:"location_id",render:({field:{onChange:s,ref:t,...c}})=>e.jsxs(l.Item,{children:[e.jsx(l.Label,{children:i("fields.location")}),e.jsx(l.Hint,{children:i("orders.fulfillment.locationDescription")}),e.jsx(l.Control,{children:e.jsxs(v,{onValueChange:s,...c,children:[e.jsx(v.Trigger,{className:"bg-ui-bg-base",ref:t,children:e.jsx(v.Value,{})}),e.jsx(v.Content,{children:o.map(p=>e.jsx(v.Item,{value:p.id,children:p.name},p.id))})]})}),e.jsx(l.ErrorMessage,{})]})}),e.jsxs(l.Item,{className:"mt-8",children:[e.jsx(l.Label,{children:i("orders.fulfillment.itemsToFulfill")}),e.jsx(l.Hint,{children:i("orders.fulfillment.itemsToFulfillDesc")}),e.jsx("div",{className:"flex flex-col gap-y-1",children:a.map(s=>e.jsx(W,{form:n,item:s,onItemRemove:b,locationId:x,currencyCode:r.currency_code},s.id))})]}),n.formState.errors.root&&e.jsxs(K,{variant:"error",dismissible:!1,className:"flex items-center",classNameInner:"flex justify-between flex-1 items-center",children:[n.formState.errors.root.message,e.jsx(C,{variant:"transparent",size:"small",type:"button",onClick:f,children:i("actions.reset")})]})]}),e.jsx("div",{className:"mt-8 pt-8 ",children:e.jsx(l.Field,{control:n.control,name:"send_notification",render:({field:{onChange:s,value:t,...c}})=>e.jsxs(l.Item,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(l.Label,{children:i("orders.returns.sendNotification")}),e.jsx(l.Control,{children:e.jsx(l.Control,{children:e.jsx(D,{checked:!!t,onCheckedChange:s,...c})})})]}),e.jsx(l.Hint,{className:"!mt-1",children:i("orders.fulfillment.sendNotificationHint")}),e.jsx(l.ErrorMessage,{})]})})})]})})})})]})})}function _e(){const{id:r}=T(),{order:i,isLoading:d,isError:m,error:j}=k(r,{fields:"currency_code,*items,*items.variant,*shipping_address"});if(m)throw j;const a=!d&&i;return e.jsx(g,{children:a&&e.jsx(J,{order:i})})}export{_e as Component};
